# Файл docker-compose.yml для проекта stock-history-service
# Использует современный формат Compose Specification (версия не требуется)

services:
  # Определяем сервис (контейнер) с именем 'postgres'
  postgres:
    # Используем официальный образ PostgreSQL 15 на базе Alpine Linux
    # Alpine — легковесный дистрибутив, образ занимает мало места
    image: postgres:15-alpine

    # Задаём понятное имя контейнеру для удобства
    container_name: stock-history-postgres

    # Переменные окружения для настройки PostgreSQL при запуске
    environment:
      # Имя базы данных, которая будет создана автоматически
      POSTGRES_DB: stock_db
      # Имя пользователя с правами суперпользователя
      POSTGRES_USER: postgres
      # Пароль для пользователя 'postgres' (в реальном проекте нужно усилить!)
      POSTGRES_PASSWORD: postgres

    # Проброс портов с хоста (твоего компьютера) в контейнер
    ports:
      # Формат "ХОСТ:КОНТЕЙНЕР". Подключаемся к БД по localhost:5432
      - "5433:5432"

    # Тома (volumes) для сохранения данных БД между перезапусками контейнера
    volumes:
      # 'postgres_data' — именованный том, объявлен в конце файла.
      # Монтируется в папку, где PostgreSQL хранит все свои файлы.
      - postgres_data:/var/lib/postgresql/data

    # Проверка здоровья контейнера (ждём, пока PostgreSQL будет готов к подключениям)
    healthcheck:
      # Команда проверки: утилита pg_isready проверяет готовность СУБД
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      # Интервал между проверками: 10 секунд
      interval: 10s
      # Таймаут на выполнение проверки: 5 секунд
      timeout: 5s
      # Количество неудачных попыток, после которых контейнер помечается "unhealthy"
      retries: 5

# Объявление тома, который будет использоваться сервисом
# Docker автоматически создаст этот том при первом запуске.
# Данные в нём сохраняются, даже если контейнер удалён.
volumes:
  postgres_data: